@page "/"
@using Blazor.Extensions;
@using Blazor.Extensions.Canvas
@using Blazor.Extensions.Canvas.Canvas2D;
@using BreakOutGame.BreakoutGame.GameObjects;
@using BreakOutGame.BreakoutGame;
@using BreakoutGame.Helpers;
@inject IJSRuntime JSRuntime;

<BECanvas Width="_gameWidth" Height="_gameHeight" @ref="_canvasReference"></BECanvas>

@code {
    private Canvas2DContext _context;
    private InputHandler _inputHandler;

    private const int _gameHeight = 600;
    private const int _gameWidth = 800;

    protected BECanvasComponent _canvasReference;

    private Ball _ball;
    private Paddle _paddle;
    private List<Brick> _bricks;

    private Task engine;

    protected override Task OnInitializedAsync()
    {

        return base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        this._context = await this._canvasReference.CreateCanvas2DAsync();

        InitalizeGameObjects();
        await DrawGameObject();

        _inputHandler = new InputHandler(_paddle);
        if (firstRender)
        {
            var jsInterop = new JsInteropHelper(JSRuntime, _inputHandler);
            await jsInterop.CallInitPaddleActions();
            engine = GameLoop();
        }
    }

    public async Task GameLoop()
    {
        var i = 0;
        while (i < 1000000)
        {
            await Task.Delay(1);
            await _context.ClearRectAsync(0, 0, _gameWidth, _gameHeight);

            UpdateGameObjects();
            await DrawGameObject();
            i++;
        }
    }

    private void UpdateGameObjects()
    {
        this._paddle.Update();
        this._ball.Update();
    }

    private async Task DrawGameObject()
    {
        foreach (var brick in _bricks)
        {
            await brick.Draw(_context);
        }
        await this._paddle.Draw(_context);
        await this._ball.Draw(_context);
    }

    private void InitalizeGameObjects()
    {
        var level = BreakoutLevel.GetLevel(2);
        this._bricks = BrickFactory.CreateBricks(level.BrickLayout, _gameWidth, _gameHeight);
        this._paddle = new Paddle(_gameWidth, _gameHeight);
        this._ball = new Ball(_gameWidth, _gameHeight, _paddle, _bricks);
    }
}